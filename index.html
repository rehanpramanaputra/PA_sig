<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Kepadatan Penduduk Kalimantan Timur</title>
  <link rel="stylesheet" href="css/leaflet.css">
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:"Poppins", Arial, sans-serif; background-color:#f0f2f5; }
    #container { display:flex; height:100%; }
    #sidebar { width:380px; background:#fff; display:flex; flex-direction:column; box-shadow:3px 0 10px rgba(0,0,0,0.1); overflow-y:auto; z-index:1000; }
    #sidebar-header { background: linear-gradient(135deg, #007bff, #00c6ff); color:#fff; padding:15px; text-align:center; font-size:17px; font-weight:600; border-bottom:3px solid #ddd; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
    #sidebar-header img { width:60px; height:60px; border-radius:50%; margin-bottom:8px; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
    #sidebar-content { padding:20px; }
    .info-box { background:#f8f9fa; border-left:5px solid #007bff; padding:12px; border-radius:10px; margin-bottom:15px; transition:all 0.2s ease; }
    .info-box:hover { transform:scale(1.02); background:#f1f8ff; }
    #search-box { margin-bottom:15px; display:flex; gap:8px; }
    #search-input { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; outline:none; font-size:14px; }
    #search-btn, #reset-btn { border:none; border-radius:8px; padding:8px 12px; cursor:pointer; transition:0.2s; color:white; }
    #search-btn { background:#007bff; } #search-btn:hover { background:#0056b3; }
    #reset-btn { background:#dc3545; } #reset-btn:hover { background:#b02a37; }

    #legend { background:white; padding:15px 12px; border-radius:12px; font-size:14px; color:#333; box-shadow:0 0 10px rgba(0,0,0,0.3); margin-bottom:15px; line-height:1.5; }
    #legend strong { display:block; font-size:15px; margin-bottom:8px; }
    #legend .legend-item { display:flex; align-items:center; margin-bottom:6px; }
    #legend .legend-color { width:22px; height:14px; margin-right:8px; border-radius:3px; border:1px solid #333; flex-shrink:0; }

    #chart-container { background:#fff; border-radius:12px; box-shadow:0 0 8px rgba(0,0,0,0.15); padding:10px; height:350px; }
    #chart-legend { display:grid; grid-template-columns:repeat(2, 1fr); gap:8px 10px; margin-top:10px; font-size:12px; }
    #chart-legend span { display:flex; align-items:center; cursor:pointer; background:#f8f9fa; border-radius:6px; padding:4px 8px; transition:0.2s; justify-content:flex-start; }
    #chart-legend span:hover { background:#e0f0ff; transform:scale(1.02); }
    #chart-legend i { width:12px; height:12px; margin-right:6px; border-radius:3px; }
    .tercoret { text-decoration:line-through; opacity:0.5; }
    .kategori-box { display:inline-block; width:14px; height:14px; border:1px solid #333; border-radius:3px; margin-right:6px; vertical-align:middle; }

    #map { flex:1; background:#d6d6d6; transition:all 0.5s ease; }
    .leaflet-tooltip.label-kota { background:rgba(255,255,255,0.75); border:none; font-size:11px; font-weight:600; color:#111; pointer-events:none; padding:1px 4px; text-shadow:0 0 2px rgba(255,255,255,0.9); }
  </style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <div id="sidebar-header">
      <img src="images/logokaltim.png" alt="Logo Kaltim">
      <div>üó∫Ô∏è Dashboard Kepadatan Penduduk <br> Kalimantan Timur</div>
    </div>
    <div id="sidebar-content">
      <div id="search-box">
        <input id="search-input" type="text" placeholder="Cari kabupaten/kota...">
        <button id="search-btn">Cari</button>
        <button id="reset-btn">Reset</button>
      </div>

      <div id="legend">
        <strong>Kepadatan (Jiwa/km¬≤)</strong>
        <div class="legend-item"><div class="legend-color" style="background:#fff5f0"></div> 0‚Äì2 (Sangat Rendah)</div>
        <div class="legend-item"><div class="legend-color" style="background:#fcbba1"></div> 2‚Äì15 (Rendah)</div>
        <div class="legend-item"><div class="legend-color" style="background:#fc9272"></div> 15‚Äì127 (Sedang)</div>
        <div class="legend-item"><div class="legend-color" style="background:#fb6a4a"></div> 127‚Äì1208 (Tinggi)</div>
        <div class="legend-item"><div class="legend-color" style="background:#67000d"></div> >1208 (Sangat Tinggi)</div>
      </div>

      <div class="info-box" id="infoWilayah">
        <strong>Info Wilayah:</strong><br>
        <em>Belum ada wilayah yang dipilih</em>
      </div>

      <div id="chart-container">
        <canvas id="chartKepadatan"></canvas>
        <div id="chart-legend"></div>
      </div>
    </div>
  </div>
  <div id="map"></div>
</div>

<script src="js/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="data/FINAL_DATA_1.js"></script>
<script>
const map = L.map('map').setView([0.5, 117.2], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

function getColor(d){ return d>1208 ? '#67000d' : d>127 ? '#fb6a4a' : d>15 ? '#fc9272' : d>2 ? '#fcbba1' : '#fff5f0'; }
function lightenColor(color, percent){
  let num=parseInt(color.slice(1),16), amt=Math.round(2.55*percent),
      R=(num>>16)+amt, G=(num>>8&0x00FF)+amt, B=(num&0x0000FF)+amt;
  return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
}
function ambilProperti(obj,...keys){ for(let k of keys) if(obj[k]!==undefined && obj[k]!==null) return obj[k]; return 0; }

const dataFitur = json_FINAL_DATA_1.features.map(f=>{
  const p=f.properties;
  return {
    nama: ambilProperti(p,"KAB_KOTA","NAMOBJ","NAMA","KABUPATEN"),
    jumlah: ambilProperti(p,"JUMLAH_PEN","JUMLAH_PDDK","PENDUDUK"),
    luas: ambilProperti(p,"WIlAYAH_KM"),
    kepadatan: ambilProperti(p,"KEPTD_KM2","KEPADATAN","KEPADATAN_JIWA")
  };
});

const ctx=document.getElementById("chartKepadatan").getContext("2d");
const labels=dataFitur.map(f=>f.nama);
const dataKepadatan=dataFitur.map(f=>f.kepadatan);
const backgroundColors=dataKepadatan.map(v=>getColor(v));

const chartKepadatan=new Chart(ctx,{
  type:"bar",
  data:{ labels, datasets:[{ label:"Kepadatan (Jiwa/km¬≤)", data:dataKepadatan, backgroundColor:backgroundColors, borderColor:"#333", borderWidth:1 }] },
  options:{ responsive:true, maintainAspectRatio:false, animation:{ duration:800, easing:'easeOutQuart' },
    plugins:{ legend:{ display:false }, title:{ display:true, text:"Kepadatan Penduduk per Kabupaten/Kota", color:"#222", font:{ size:14, weight:"bold" } } },
    scales:{ x:{ ticks:{ maxRotation:45, minRotation:45, font:{ size:10 } }, grid:{ display:false } }, y:{ beginAtZero:true, title:{ display:true, text:"Jiwa/km¬≤" }, grid:{ color:"#eee" } } }
  }
});

let chartLocked = false; // Kunci chart ketika klik peta

const legendContainer=document.getElementById("chart-legend");
labels.forEach((label,i)=>{
  const span=document.createElement("span");
  span.innerHTML=`<i style="background:${backgroundColors[i]}"></i>${label}`;
  let isHidden=false; // state toggle
  const originalValue = dataKepadatan[i]; // simpan nilai asli
  span.addEventListener("click",()=>{
    if(chartLocked) return; // tidak bisa ubah jika locked
    isHidden = !isHidden;
    chartKepadatan.data.datasets[0].data[i] = isHidden ? 0 : originalValue;
    span.classList.toggle("tercoret",isHidden);
    chartKepadatan.update({ duration:800, easing:'easeOutQuart' });
  });
  legendContainer.appendChild(span);
});

function resetChart(){
  chartKepadatan.data.labels=labels;
  chartKepadatan.data.datasets[0].data=dataKepadatan;
  chartKepadatan.data.datasets[0].backgroundColor=backgroundColors;
  chartKepadatan.update({ duration:800, easing:'easeOutQuart' });
  document.querySelectorAll("#chart-legend span").forEach(s=>s.classList.remove("tercoret"));
  chartLocked = false; // unlock chart
}

function getKategori(v){
  if(v>1208) return { text:"Sangat Tinggi", color:"#67000d" };
  if(v>127) return { text:"Tinggi", color:"#fb6a4a" };
  if(v>15) return { text:"Sedang", color:"#fc9272" };
  if(v>2) return { text:"Rendah", color:"#fcbba1" };
  return { text:"Sangat Rendah", color:"#fff5f0" };
}

function style(feature){
  const kepadatan=ambilProperti(feature.properties,"KEPTD_KM2","KEPADATAN","KEPADATAN_JIWA");
  return { fillColor:getColor(kepadatan), weight:1.2, opacity:1, color:"#555", fillOpacity:1 };
}

let activeLayer=null;
function onEachFeature(feature,layer){
  const props=feature.properties;
  const nama=ambilProperti(props,"KAB_KOTA","NAMOBJ","NAMA","KABUPATEN");
  const jumlah=ambilProperti(props,"JUMLAH_PEN","JUMLAH_PDDK","PENDUDUK");
  const luas=ambilProperti(props,"WIlAYAH_KM");
  const kepadatan=ambilProperti(props,"KEPTD_KM2","KEPADATAN","KEPADATAN_JIWA");
  const baseColor=getColor(kepadatan);

  layer.on({
    mouseover:e=>e.target.setStyle({ weight:2, color:"#000" }),
    mouseout:e=>{ if(activeLayer!==e.target) geojson.resetStyle(e.target); },
    click:e=>{
      if(activeLayer===e.target){ // toggle kembali ke default jika klik lagi
        geojson.resetStyle(e.target);
        activeLayer=null;
        document.getElementById('infoWilayah').innerHTML="<strong>Info Wilayah:</strong><br><em>Belum ada wilayah yang dipilih</em>";
        resetChart();
        return;
      }

      if(activeLayer) geojson.resetStyle(activeLayer);
      activeLayer=e.target;
      chartLocked = true; // lock chart saat klik peta
      e.target.setStyle({ weight:4, color:"#000", fillColor:lightenColor(baseColor,25) });

      const kategori=getKategori(kepadatan);
      document.getElementById('infoWilayah').innerHTML=`
        <strong>Kabupaten/Kota:</strong> ${nama}<br>
        <strong>Jumlah Penduduk:</strong> ${jumlah?.toLocaleString()||'-'} jiwa<br>
        <strong>Luas Wilayah:</strong> ${luas?.toLocaleString()||'-'} km¬≤<br>
        <strong>Kepadatan:</strong> ${kepadatan?.toLocaleString()||'-'} jiwa/km¬≤<br>
        <strong>Kategori:</strong> <span class="kategori-box" style="background:${kategori.color}"></span> ${kategori.text}
      `;

      chartKepadatan.data.labels=[nama];
      chartKepadatan.data.datasets[0].data=[kepadatan];
      chartKepadatan.data.datasets[0].backgroundColor=[baseColor];
      chartKepadatan.update({ duration:800, easing:'easeOutQuart' });

      map.flyToBounds(e.target.getBounds(),{ duration:2 });
    }
  });

  if(nama){
    const center=layer.getBounds().getCenter();
    L.tooltip({ permanent:true, direction:"center", className:"label-kota" })
      .setLatLng(center).setContent(nama).addTo(map);
  }
}

const geojson=L.geoJson(json_FINAL_DATA_1,{ style, onEachFeature }).addTo(map);

// Reset
document.getElementById("reset-btn").addEventListener("click",()=>{
  map.flyTo([0.5,117.2],7);
  if(activeLayer) geojson.resetStyle(activeLayer);
  activeLayer=null;
  document.getElementById("infoWilayah").innerHTML="<strong>Info Wilayah:</strong><br><em>Belum ada wilayah yang dipilih</em>";
  resetChart();
});

// SEARCH EXACT MATCH FULL NAME
document.getElementById("search-btn").addEventListener("click",()=>{
  const val = document.getElementById("search-input").value.toLowerCase().trim();
  if(!val) return;

  let foundLayer = null;
  geojson.eachLayer(l=>{
    const name = ambilProperti(l.feature.properties,"KAB_KOTA","NAMOBJ","NAMA","KABUPATEN").toLowerCase().trim();
    if(name === val) { foundLayer = l; return; }
  });

  if(foundLayer){
    map.flyToBounds(foundLayer.getBounds(),{duration:2});
    foundLayer.fire("click");
  }else{
    alert("Wilayah tidak ditemukan. Harap tulis nama lengkap kabupaten/kota.");
  }
});
</script>
</body>
</html>
